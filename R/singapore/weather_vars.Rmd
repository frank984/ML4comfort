---
title: "Cool Quiet City"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)
```

## Packages loading

```{r}
# Load packages
library(scales)
library(dplyr)
library(tidyr)
library(tidyverse)
library(ggplot2)
library(ggpubr)
library(lubridate)

library(sp)
library(spacetime)
# library(ozmaps)
library(sf)
#library(ggmap)
library(gstat)
library(automap)


load("cleaned_data.Rdata")

```
## Time range

```{r}
as.Date(range(cozie_train$time))
as.Date(range(cozie_test$time))

as.Date(range(air_temp$time))
as.Date(range(RH$time))
as.Date(range(wind_dir$time))
as.Date(range(wind_speed$time))
as.Date(range(rainfall$time))
```
## Visualitazion of the target variables

```{r}
target_vars=c("q_earphones","q_noise_kind","q_noise_nearby","q_thermal_preference")

par(mfrow=c(2,2))
# ggplot(cozie_train,aes(x=time,y=cozie_train[,target_vars[1]]))+
#   geom_point()+
#   scale_x_datetime(labels = date_format("%y-%m"))+
#   theme_bw()+
#   labs(title=target_vars[1],y=" ",x="Time")
# ggplot(cozie_train,aes(x=time,y=cozie_train[,target_vars[2]]))+
#   geom_point()+
#   scale_x_datetime(labels = date_format("%y-%m"))+
#   theme_bw()+
#   labs(title=target_vars[2],y=" ",x="Time")
# ggplot(cozie_train,aes(x=time,y=cozie_train[,target_vars[3]]))+
#   geom_point()+
#   scale_x_datetime(labels = date_format("%y-%m"))+
#   theme_bw()+
#   labs(title=target_vars[3],y=" ",x="Time")
# ggplot(cozie_train,aes(x=time,y=cozie_train[,target_vars[4]]))+
#   geom_point()+
#   scale_x_datetime(labels = date_format("%y-%m"))+
#   theme_bw()+
#   labs(title=target_vars[4],y=" ",x="Time")

plot(cozie_train$time,cozie_train[,target_vars[1]],
     xlab="Time",ylab=target_vars[1])
plot(cozie_train$time,cozie_train[,target_vars[2]],
     xlab="Time",ylab=target_vars[2])
plot(cozie_train$time,cozie_train[,target_vars[3]],
     xlab="Time",ylab=target_vars[3])
plot(cozie_train$time,cozie_train[,target_vars[4]],
     xlab="Time",ylab=target_vars[4])
```

# First and second time window

There is a time window between January and April with no observations. Let us split the data in two parts, one until 2023-01-21 15:00:16 (indexed 614909), and the other starting from 2023-03-27 11:55:01 (indexed 615204).

```{r}
last_date_first_wind=cozie_train$time[614909]
first_date_second_wind=cozie_train$time[615204]
```

# Summarize weather data data

```{r}
weather_summ=function(x,window="30 minutes"){
  
  mean_x=x %>% group_by(time=floor_date(time,window))%>%
    summarise_if(is.numeric, mean, na.rm = TRUE)
  sd_x=x %>% group_by(time=floor_date(time,window))%>%
    summarise_if(is.numeric, sd, na.rm = TRUE)
  
  return(list(mean_x=mean_x,sd_x=sd_x))
  
}
```

```{r}
wdn="1 hour"
wdn2="30 mins"

air_temp_wdn=weather_summ(air_temp,window=wdn)
rainfall_wdn=weather_summ(rainfall,window=wdn)
RH_wdn=weather_summ(RH,window=wdn)
wind_dir_wdn=weather_summ(wind_dir,window=wdn)
wind_speed_wdn=weather_summ(wind_speed,window=wdn)

air_temp_wdn2=weather_summ(air_temp,window=wdn2)
rainfall_wdn2=weather_summ(rainfall,window=wdn2)
RH_wdn2=weather_summ(RH,window=wdn2)
wind_dir_wdn2=weather_summ(wind_dir,window=wdn2)
wind_speed_wdn2=weather_summ(wind_speed,window=wdn2)
```

# Maximum variability for 30 mins and 1 hour frequency

```{r}

max(air_temp_wdn$sd_x[,-1],na.rm = T)
max(rainfall_wdn$sd_x[,-1],na.rm = T)
max(RH_wdn$sd_x[,-1],na.rm = T)
max(wind_dir_wdn$sd_x[,-1],na.rm = T)
max(wind_speed_wdn$sd_x[,-1],na.rm = T)

max(air_temp_wdn2$sd_x[,-1],na.rm = T)
max(rainfall_wdn2$sd_x[,-1],na.rm = T)
max(RH_wdn2$sd_x[,-1],na.rm = T)
max(wind_dir_wdn2$sd_x[,-1],na.rm = T)
max(wind_speed_wdn2$sd_x[,-1],na.rm = T)

```

No huge difference between the two, let us keep the 1 hour frequency dataset.

# Air temperature

```{r}
air_temp_wdn_long=air_temp_wdn$mean_x %>%
  pivot_longer(!time, names_to = "location", values_to = "air_temperature")

ggplot(data=air_temp_wdn_long, aes(x=time, y = air_temperature)) + 
  geom_line(color="#9999CC",na.rm = F) + facet_wrap(~location,nrow=6,ncol=3)+
  scale_x_datetime(labels = date_format("%y-%m"))+
  theme_bw()+
  labs(title="Air temperature",y=" ",x="Time")+
  theme(axis.text.x = element_text(size=5),
        axis.text.y = element_text(size=5),
        strip.text = element_text(size=5),
        panel.spacing = unit(.5, 'pt'))

```

# Rainfall

```{r}
rainfall_wdn_long=rainfall_wdn$mean_x %>%
  pivot_longer(!time, names_to = "location", values_to = "rainfall")

ggplot(data=rainfall_wdn_long, aes(x=time, y = rainfall)) + 
  geom_line(color="#9999CC",na.rm = F) + facet_wrap(~location)+
  scale_x_datetime(labels = date_format("%y-%m"))+
  theme_bw()+
  labs(title="Rainfall",y=" ",x="Time")+
  theme(axis.text=element_text(size=5),strip.background=element_blank(),  strip.text.x = element_blank())

```

# Relative humidity

```{r}
RH_wdn_long=RH_wdn$mean_x %>%
  pivot_longer(!time, names_to = "location", values_to = "RH")

ggplot(data=RH_wdn_long, aes(x=time, y = RH)) + 
  geom_line(color="#9999CC",na.rm = F) + facet_wrap(~location,nrow=6,ncol=3)+
  scale_x_datetime(labels = date_format("%y-%m"))+
  theme_bw()+
  labs(title="Relative humidity",y=" ",x="Time")+
  theme(axis.text.x = element_text(size=5),
        axis.text.y = element_text(size=5),
        strip.text = element_text(size=5),
        panel.spacing = unit(.5, 'pt'))

```

# Wind speed

```{r}
wind_speed_wdn_long=wind_speed_wdn$mean_x %>%
  pivot_longer(!time, names_to = "location", values_to = "wind_speed")

ggplot(data=wind_speed_wdn_long, aes(x=time, y = wind_speed)) + 
  geom_line(color="#9999CC",na.rm = F) + facet_wrap(~location,nrow=6,ncol=3)+
  scale_x_datetime(labels = date_format("%y-%m"))+
  theme_bw()+
  labs(title="Wind speed",y=" ",x="Time")+
  theme(axis.text.x = element_text(size=5),
        axis.text.y = element_text(size=5),
        strip.text = element_text(size=5),
        panel.spacing = unit(.5, 'pt'))

```

# Wind direction

```{r}
wind_dir_wdn_long=wind_dir_wdn$mean_x %>%
  pivot_longer(!time, names_to = "location", values_to = "wind_dir")

ggplot(data=wind_dir_wdn_long, aes(x=time, y = wind_dir)) + 
  geom_line(color="#9999CC",na.rm = F) + facet_wrap(~location,nrow=6,ncol=3)+
  scale_x_datetime(labels = date_format("%y-%m"))+
  theme_bw()+
  labs(title="Wind direction",y=" ",x="Time")+
  theme(axis.text.x = element_text(size=5),
        axis.text.y = element_text(size=5),
        strip.text = element_text(size=5),
        panel.spacing = unit(.5, 'pt'))

```

There is a time window in which data is somehow linearly interpolated. 

```{r}
t_breaks = seq(from = ymd_hms(head(air_temp$time,1)), 
               to = ymd_hms(tail(air_temp$time,1)), 
               by = '1 day')

ggplot(air_temp[119076:144963,])+
  geom_line(aes(x=time,
                y=S44))+
  scale_x_datetime(breaks = t_breaks,
                   labels = date_format("%y-%m-%d"))+
  theme_bw()+
  theme(axis.text.x = element_text(size=5),
        axis.text.y = element_text(size=5))
```

From January 1st until January 11th. Let us get rid of these observations.

```{r}
last_date_first_wind=as.POSIXct("2022-12-31 23:59:00 +08")
```

## First window analysis

```{r}
air_temp1=air_temp_wdn$mean_x[air_temp_wdn$mean_x$time<=last_date_first_wind,]
# dim(air_temp1)
# summary(air_temp1)

rainfall1=rainfall_wdn$mean_x[rainfall_wdn$mean_x$time<=last_date_first_wind,]
#dim(rainfall1)
# summary(rainfall1)
# tail(rainfall1)

RH1=RH_wdn$mean_x[RH_wdn$mean_x$time<=last_date_first_wind,]
wind_dir1=wind_dir_wdn$mean_x[wind_dir_wdn$mean_x$time<=last_date_first_wind,]
wind_speed1=wind_speed_wdn$mean_x[wind_speed_wdn$mean_x$time<=last_date_first_wind,]

```

Air temperature - percentage of NAs

```{r}
apply(air_temp1,2,function(x){sum(is.na(x))/length(x)*100})
```

Drop S117 (all NAs).

```{r}
air_temp1=subset(air_temp1, select = -S117)
```

Rainfall - percentage of NAs
```{r}
apply(rainfall1,2,function(x){sum(is.na(x))/length(x)*100})
```

Drop S36, S82.

```{r}
rainfall1=subset(rainfall1, select = -c(S36,S82))
```


Relative humidity - percentage of NAs

```{r}
apply(RH1,2,function(x){sum(is.na(x))/length(x)*100})
```

Wind direction - percentage of NAs

```{r}
apply(wind_dir1,2,function(x){sum(is.na(x))/length(x)*100})
```

Wind speed - percentage of NAs

```{r}
apply(wind_speed1,2,function(x){sum(is.na(x))/length(x)*100})
```


# 1 - Univariate temporal kriging

The following function performs temporal kriging (needed to "fill the gaps" in the datasets).
```{r}
temp_krige=function(x){
  x_sp=x
  
  temp_grid=1:nrow(x)
  temp_grid=expand.grid(temp_grid,1)
  colnames(temp_grid)=c("indx","knot")
  gridded(temp_grid)=~indx+knot
  
  for(i in 2:ncol(x)){
    #i=17
    x_sp=x[,c(1,i)]
    ind_fill=which(is.na(x_sp[,2]))
    NAcount=sum(is.na(x_sp[,2]))
    
    if(NAcount>0){
      colnames(x_sp)=c("time","z")
      x_sp$indx=1:nrow(x_sp)
      x_sp$knot=1
      x_sp=drop_na(x_sp)
      coordinates(x_sp) <- ~ indx + knot
      
      onedim_krig = autoKrige(z~1, x_sp,temp_grid)
      x[ind_fill,i]=onedim_krig$krige_output$var1.pred[ind_fill]
    }
  }
  return(x)
}
```

$\textbf{Air temperature}$

```{r}
air_temp1_sp=air_temp1

air_temp1_sp$knot=1
air_temp1_sp$indx=1:nrow(air_temp1_sp)

air_temp1_sp.full=temp_krige(air_temp1_sp)
air_temp1_sp.full=subset(air_temp1_sp.full,select=-c(indx,knot))
apply(air_temp1_sp.full,2,function(x)sum(is.na(x)))
apply(air_temp1_sp,2,function(x)sum(is.na(x)))

```

Stations 102 and 108 had the highest number of NAs

```{r}
par(mfrow=c(2,1))
plot(air_temp1_sp.full$time,air_temp1_sp.full$S102,
     type='l',ylab="S102",main="Air temperature",xlab="Time")
plot(air_temp1_sp.full$time,air_temp1_sp.full$S108,
     type='l',ylab="S108",xlab="Time")
```


$\textbf{Rainfall}$

```{r}
rainfall1_sp=rainfall1

apply(rainfall1_sp,2,function(x)sum(is.na(x)))

#Remove stations S36, S82
#rainfall1_sp=subset(rainfall1_sp,select=-c(S36,S82))

rainfall1_sp$knot=1
rainfall1_sp$indx=1:nrow(rainfall1_sp)

rainfall1_sp.full=temp_krige(rainfall1_sp)
rainfall1_sp.full=subset(rainfall1_sp.full,select=-c(indx,knot))

apply(rainfall1_sp.full,2,function(x)sum(is.na(x)))
apply(rainfall1_sp,2,function(x)sum(is.na(x)))

```

Stations 102 and 108

```{r}
par(mfrow=c(2,1))
plot(rainfall1_sp.full$time,rainfall1_sp.full$S102,
     type='l',ylab="S102",main="Rainfall",xlab="Time")
plot(rainfall1_sp.full$time,rainfall1_sp.full$S108,
     type='l',ylab="S108",xlab="Time")
```

$\textbf{Relative humidity}$

```{r}
RH1_sp=RH1

RH1_sp$knot=1
RH1_sp$indx=1:nrow(RH1_sp)

RH1_sp.full=temp_krige(RH1_sp)
RH1_sp.full=subset(RH1_sp.full,select=-c(indx,knot))

apply(RH1_sp.full,2,function(x)sum(is.na(x)))
apply(RH1_sp,2,function(x)sum(is.na(x)))

```

Stations 102 and 108

```{r}
par(mfrow=c(2,1))
plot(RH1_sp.full$time,RH1_sp.full$S102,
     type='l',ylab="S102",main="Relative humidity",xlab="Time")
plot(RH1_sp.full$time,RH1_sp.full$S108,
     type='l',ylab="S108",xlab="Time")
```


$\textbf{Wind speed}$

```{r}
wind_speed1_sp=wind_speed1

wind_speed1_sp$knot=1
wind_speed1_sp$indx=1:nrow(wind_speed1_sp)

wind_speed1_sp.full=temp_krige(wind_speed1_sp)
wind_speed1_sp.full=subset(wind_speed1_sp.full,select=-c(indx,knot))

apply(wind_speed1_sp.full,2,function(x)sum(is.na(x)))
apply(wind_speed1_sp,2,function(x)sum(is.na(x)))

```

Stations 102 and 108 had the highest number of NAs.

```{r}
par(mfrow=c(2,1))
plot(wind_speed1_sp.full$time,wind_speed1_sp.full$S102,
     type='l',ylab="S102",main="Wind speed",xlab="Time")
plot(wind_speed1_sp.full$time,wind_speed1_sp.full$S108,
     type='l',ylab="S108",xlab="Time")
```

$\textbf{Wind direction}$

```{r}
wind_dir1_sp=wind_dir1

wind_dir1_sp$knot=1
wind_dir1_sp$indx=1:nrow(wind_dir1_sp)

wind_dir1_sp.full=temp_krige(wind_dir1_sp)
wind_dir1_sp.full=subset(wind_dir1_sp.full,select=-c(indx,knot))

apply(wind_dir1_sp.full,2,function(x)sum(is.na(x)))
apply(wind_dir1_sp,2,function(x)sum(is.na(x)))

```

Stations 102 and 108 had the highest number of NAs.

```{r}
par(mfrow=c(2,1))
plot(wind_dir1_sp.full$time,wind_dir1_sp.full$S102,
     type='l',main="Wind direction",ylab="S102",xlab="Time")
plot(wind_dir1_sp.full$time,wind_dir1_sp.full$S108,
     type='l',ylab="S108",xlab="Time")
```
## Second window analysis

```{r}
air_temp2=air_temp_wdn$mean_x[air_temp_wdn$mean_x$time>=first_date_second_wind,]
# dim(air_temp1)
# summary(air_temp1)

rainfall2=rainfall_wdn$mean_x[rainfall_wdn$mean_x$time>=first_date_second_wind,]
#dim(rainfall1)
# summary(rainfall1)
# tail(rainfall1)

RH2=RH_wdn$mean_x[RH_wdn$mean_x$time>=first_date_second_wind,]
wind_dir2=wind_dir_wdn$mean_x[wind_dir_wdn$mean_x$time>=first_date_second_wind,]
wind_speed2=wind_speed_wdn$mean_x[wind_speed_wdn$mean_x$time>=first_date_second_wind,]

```

Air temperature - percentage of NAs

```{r}
apply(air_temp2,2,function(x){sum(is.na(x))/length(x)*100})
```

Drop S102, S100, S108

```{r}
air_temp2=subset(air_temp2, select = -c(S102,S100,S108))
```

Rainfall - percentage of NAs
```{r}
apply(rainfall2,2,function(x){sum(is.na(x))/length(x)*100})
```

Drop S36, S61, S82, S100, S102, S108, S202

```{r}
rainfall2=subset(rainfall2, select = -c(S36, S61, S82, S100, S102, S108, S202))
```


Relative humidity - percentage of NAs

```{r}
apply(RH2,2,function(x){sum(is.na(x))/length(x)*100})
```

Drop S100, S102, S108

```{r}
RH2=subset(RH2, select = -c(S100, S102, S108))
```

Wind direction - percentage of NAs

```{r}
apply(wind_dir2,2,function(x){sum(is.na(x))/length(x)*100})
```
Drop S102, S100, S106, S108, S117

```{r}
wind_dir2=subset(wind_dir2, select = -c(S102, S100, S106, S108, S117))
```

Wind speed - percentage of NAs

```{r}
apply(wind_speed2,2,function(x){sum(is.na(x))/length(x)*100})
```
Drop S102,S100, S106, S108, S117


```{r}
wind_speed2=subset(wind_speed2, select = -c(S102,S100, S106, S108, S117))
```

# 2 - Univariate temporal kriging

The following function performs temporal kriging (needed to "fill the gaps" in the datasets).
```{r}
temp_krige=function(x){
  x_sp=x
  
  temp_grid=1:nrow(x)
  temp_grid=expand.grid(temp_grid,1)
  colnames(temp_grid)=c("indx","knot")
  gridded(temp_grid)=~indx+knot
  
  for(i in 2:ncol(x)){
    #i=17
    x_sp=x[,c(1,i)]
    ind_fill=which(is.na(x_sp[,2]))
    NAcount=sum(is.na(x_sp[,2]))
    
    if(NAcount>0){
      colnames(x_sp)=c("time","z")
      x_sp$indx=1:nrow(x_sp)
      x_sp$knot=1
      x_sp=drop_na(x_sp)
      coordinates(x_sp) <- ~ indx + knot
      
      onedim_krig = autoKrige(z~1, x_sp,temp_grid)
      x[ind_fill,i]=onedim_krig$krige_output$var1.pred[ind_fill]
    }
  }
  return(x)
}
```

$\textbf{Air temperature}$

```{r}
air_temp2_sp=air_temp2

air_temp2_sp$knot=1
air_temp2_sp$indx=1:nrow(air_temp2_sp)

air_temp2_sp.full=temp_krige(air_temp2_sp)
air_temp2_sp.full=subset(air_temp2_sp.full,select=-c(indx,knot))
apply(air_temp2_sp.full,2,function(x)sum(is.na(x)))
apply(air_temp2_sp,2,function(x)sum(is.na(x)))

```

Stations 115 and 121 had the highest number of NAs

```{r}
par(mfrow=c(2,1))
plot(air_temp2_sp.full$time,air_temp2_sp.full$S115,
     type='l',ylab="S115",main="Air temperature",xlab="Time")
plot(air_temp2_sp.full$time,air_temp2_sp.full$S121,
     type='l',ylab="S121",xlab="Time")
```


$\textbf{Rainfall}$

```{r}
rainfall2_sp=rainfall2

apply(rainfall2_sp,2,function(x)sum(is.na(x)))


rainfall2_sp$knot=1
rainfall2_sp$indx=1:nrow(rainfall2_sp)

rainfall2_sp.full=temp_krige(rainfall2_sp)
rainfall2_sp.full=subset(rainfall2_sp.full,select=-c(indx,knot))

apply(rainfall2_sp.full,2,function(x)sum(is.na(x)))
apply(rainfall2_sp,2,function(x)sum(is.na(x)))

```

Stations S84 ,121, 115 and 109

```{r}
par(mfrow=c(4,1))
plot(rainfall2_sp.full$time,rainfall2_sp.full$S84,
     type='l',ylab="S4",main="Rainfall",xlab="Time")
plot(rainfall2_sp.full$time,rainfall2_sp.full$S115,
     type='l',ylab="S115",xlab="Time")
plot(rainfall2_sp.full$time,rainfall2_sp.full$S121,
     type='l',ylab="S121",xlab="Time")
plot(rainfall2_sp.full$time,rainfall2_sp.full$S109,
     type='l',ylab="S109",xlab="Time")
```

$\textbf{Relative humidity}$

```{r}
RH2_sp=RH2

RH2_sp$knot=1
RH2_sp$indx=1:nrow(RH2_sp)

RH2_sp.full=temp_krige(RH2_sp)
RH2_sp.full=subset(RH2_sp.full,select=-c(indx,knot))

apply(RH2_sp.full,2,function(x)sum(is.na(x)))
apply(RH2_sp,2,function(x)sum(is.na(x)))

```

Stations 109, 115 and 121

```{r}
par(mfrow=c(3,1))
plot(RH2_sp.full$time,RH2_sp.full$S109,
     type='l',ylab="S109",main="Relative humidity",xlab="Time")
plot(RH2_sp.full$time,RH2_sp.full$S115,
     type='l',ylab="S115",xlab="Time")
plot(RH2_sp.full$time,RH2_sp.full$S121,
     type='l',ylab="S121",xlab="Time")
```


$\textbf{Wind speed}$

```{r}
wind_speed2_sp=wind_speed2

wind_speed2_sp$knot=1
wind_speed2_sp$indx=1:nrow(wind_speed2_sp)

wind_speed2_sp.full=temp_krige(wind_speed2_sp)
wind_speed2_sp.full=subset(wind_speed2_sp.full,select=-c(indx,knot))

apply(wind_speed2_sp.full,2,function(x)sum(is.na(x)))
apply(wind_speed2_sp,2,function(x)sum(is.na(x)))

```

Stations 115 and 121 have the highest number of NAs.

```{r}
par(mfrow=c(2,1))
plot(wind_speed2_sp.full$time,wind_speed2_sp.full$S115,
     type='l',ylab="S115",main="Wind speed",xlab="Time")
plot(wind_speed2_sp.full$time,wind_speed2_sp.full$S121,
     type='l',ylab="S121",xlab="Time")
```

$\textbf{Wind direction}$

```{r}
wind_dir2_sp=wind_dir2

wind_dir2_sp$knot=1
wind_dir2_sp$indx=1:nrow(wind_dir2_sp)

wind_dir2_sp.full=temp_krige(wind_dir2_sp)
wind_dir2_sp.full=subset(wind_dir2_sp.full,select=-c(indx,knot))

apply(wind_dir2_sp.full,2,function(x)sum(is.na(x)))
apply(wind_dir2_sp,2,function(x)sum(is.na(x)))

```

Stations 121 and 115 have the highest number of NAs.

```{r}
par(mfrow=c(2,1))
plot(wind_dir2_sp.full$time,wind_dir2_sp.full$S121,
     type='l',ylab="S121",xlab="Time")
plot(wind_dir2_sp.full$time,wind_dir2_sp.full$S115,
     type='l',ylab="S115",xlab="Time")
```

# Save results of temporal kriging

```{r}

# save(air_temp1_sp.full,file="air_temp1_sp.full.Rdata")
# save(rainfall1_sp.full,file="rainfall1_sp.full.Rdata")
# save(RH1_sp.full,file="RH1_sp.full.Rdata")
# save(wind_speed1_sp.full,file="wind_speed1_sp.full.Rdata")
# save(wind_dir1_sp.full,file="wind_dir1_sp.full.Rdata")
load("air_temp1_sp.full.Rdata")
load("rainfall1_sp.full.Rdata")
load("RH1_sp.full.Rdata")
load("wind_speed1_sp.full.Rdata")
load("wind_dir1_sp.full.Rdata")

# save(air_temp2_sp.full,file="air_temp2_sp.full.Rdata")
# save(rainfall2_sp.full,file="rainfall2_sp.full.Rdata")
# save(RH2_sp.full,file="RH2_sp.full.Rdata")
# save(wind_dir2_sp.full,file="wind_dir2_sp.full.Rdata")
# save(wind_speed2_sp.full,file="wind_speed2_sp.full.Rdata")
load("air_temp2_sp.full.Rdata")
load("rainfall2_sp.full.Rdata")
load("RH2_sp.full.Rdata")
load("wind_dir2_sp.full.Rdata")
load("wind_speed2_sp.full.Rdata")

```

# Spatio-temporal kriging

Define spatial grid

Two crucial questions emerge:

1) What range of values should we employ for latitude and longitude? We opt for the maximum and minimum values recorded by the Cozie app or the weather stations.

2) What level of granularity should we adopt for latitude and longitude? I don't have a definitive answer to this query, but higher granularity implies increased computational expenses.

```{r}
lat_range_cozie=range(cozie_train$ws_latitude,na.rm=T)
lat_range_weath=range(locations$latitude,na.rm=T)
lon_range_cozie=range(cozie_train$ws_longitude,na.rm=T)
lon_range_weath=range(locations$longitude,na.rm=T)

LAT=c(min(lat_range_cozie[1],lat_range_weath[1]),
      max(lat_range_cozie[2],lat_range_weath[2]))

LON=c(min(lon_range_cozie[1],lon_range_weath[1]),
      max(lon_range_cozie[2],lon_range_weath[2]))

# Better idea: only consider locations at which survey data were collected
load("df_cozie.Rdata")
cozie_locations=df_cozie[,c("ws_latitude","ws_longitude")]
# cozie_locations$ws_latitude=as.factor(cozie_locations$ws_latitude)
# cozie_locations$ws_longitude=as.factor(cozie_locations$ws_longitude)

#Consider only distinct pairs
pairs=cozie_locations %>% group_by(ws_latitude,ws_longitude) %>%
      summarize(Count = n())

grid_coords=pairs[,c("ws_latitude","ws_longitude")]
# lats=pairs$ws_latitude
# lons=pairs$ws_longitude

```

Function for spatio-temporal kriging

```{r}

spatio_temp_kr=function(x,locations,grid_coords){
  indx=locations$id%in%colnames(x)
  
  # spatial locations of weather stations in singapore
  x_sp =locations[indx,c("latitude","longitude")]
  row.names(x_sp) = locations$id[indx]
  x_sp = SpatialPoints(x_sp)
  
  # Define time points
  time=x$time
  
  # Define long data.frame with air temperature values
  # time is of length m, then
  # data is a data.frame with n*m rows corresponding to the observations
  
  x_t=as.vector(t(x[,-1]))
  xdata=data.frame(xv=x_t,time=rep(time,each=ncol(x[,-1])))
  
  stfdf_x = STFDF(x_sp, time, data = xdata)
  
  start=Sys.time()
  # Fit empirical variogram
  vv = variogram(xv~1, stfdf_x, 
                 width=90, 
                 cutoff = 200,
                 tlags=0:5
  )
  
  metricVgm <- vgmST("metric",
                     joint=vgm(psill=50,
                               model="Exp",
                               range=100,
                               nugget=0),
                     stAni=30)
  metricVgm <- fit.StVariogram(vv, metricVgm)
  #attr(metricVgm, "optim")$value
  # Metric model 
  end=Sys.time()
  
  extime_vgm=end-start
  # windows()
  # plot(vv, metricVgm)
  
#   # Separable model
#   sepVgm <- vgmST("separable",
#                   space=vgm(0.9,"Exp", 123, 0.1),
#                   time =vgm(0.9,"Exp", 2.9, 0.1),
#                   sill=100)
#   
#   sepVgm <- fit.StVariogram(vv, sepVgm, method = "L-BFGS-B"
#                             # ,
#                             # lower = c(10,0,0.01,0,1),
#                             # upper = c(500,1,20,1,200)
#   )
  
  # len.out=100 #preliminary choice
  # grid_lat=seq(LAT[1],LAT[2],length.out=len.out)
  # grid_lon=seq(LON[1],LON[2],length.out=len.out)
  
  x_gridded <- SpatialPoints(grid_coords,
                             proj4string=CRS(proj4string(stfdf_x@sp)))
  
  # x_gridded = SpatialPoints(pairs, 
  #                           proj4string=CRS(proj4string(stfdf_x@sp)))
  
  # gridded(x_gridded) <- TRUE
  
  x_pred <- STF(sp=as(x_gridded,"SpatialPoints"), time=stfdf_x@time)
  
  start=Sys.time()
  x_kriged <- krigeST(xv~1, data=stfdf_x, newdata=x_pred,
                              modelList=metricVgm)
  end=Sys.time()
  extime_krg=end-start

  df_plotkrige=as.data.frame(x_kriged)
                             
  return(list(df_plotkrige=df_plotkrige,
              extime_vgm=extime_vgm,
              extime_krg=extime_krg,
              variogrm=metricVgm,
              krige_obj=x_kriged)
         )
 }

```

Spatio-temporal kriging is impractical due to memory constraints, as it generates files exceeding 500 GB.

```{r}

# air1_krg=spatio_temp_kr(air_temp1_sp.full,locations,grid_coords)
# save(air1_krg,file="air1_krg.Rdata")
# air2_krg=spatio_temp_kr(air_temp2_sp.full,locations,grid_coords)
# save(air2_krg,file="air2_krg.Rdata")
# 
# RH1_krg=spatio_temp_kr(RH1_sp.full,locations,grid_coords)
# save(RH1_krg,file="RH1_krg.Rdata")
# 
# RH2_krg=spatio_temp_kr(RH2_sp.full,locations,grid_coords)
# save(RH2_krg,file="RH2_krg.Rdata")
# 
# rainfall1_krg=spatio_temp_kr(rainfall1_sp.full,locations,grid_coords)
# save(rainfall1_krg,file="rainfall1_krg.Rdata")
# 
# rainfall2_krg=spatio_temp_kr(rainfall2_sp.full,locations,grid_coords)
# save(rainfall2_krg,file="rainfall2_krg.Rdata")
# 
# wind_dir1_krg=spatio_temp_kr(wind_dir1_sp.full,locations,grid_coords)
# save(wind_dir1_krg,file="wind_dir1_krg.Rdata")
# 
# wind_dir2_krg=spatio_temp_kr(wind_dir2_sp.full,locations,grid_coords)
# save(wind_dir2_krg,file="wind_dir2_krg.Rdata")
# 
# wind_speed1_krg=spatio_temp_kr(wind_speed1_sp.full,locations,grid_coords)
# save(wind_speed1_krg,file="wind_speed1_krg.Rdata")
# 
# wind_speed2_krg=spatio_temp_kr(wind_speed2_sp.full,locations,grid_coords)
# save(wind_speed2_krg,file="wind_speed2_krg.Rdata")

```


## Match survey, physio, and weather variable

```{r}

match_krg_weath_coz=function(df_cozie,x_kriged,var_name){
  # df_cozie is the physio and survey dataset
  # x_kriged is the weather variable dataset after kriging has been performed
  # var_name is the name of the weather variable

  # extract kriged data
  B=x_kriged$df_plotkrige
  
  # extract times
  Btime=data.frame(time=index(x$krige_obj@time),
                   timeIndex=x$krige_obj@time,
                   row.names = x$krige_obj@time)
  
  # match times
  AB=bayesbio::nearestTime(df_cozie,Btime,"time","time")
  AB$newvar=0
  
  for(i in 1:nrow(AB)){
    
    tI=AB$timeIndex[i]
    B_temp=B[which(B$timeIndex==tI),]
    
    ref_points=unlist(as.vector(A[i,c("ws_latitude", "ws_longitude")]))
    
    # Find point in B_temp[c("ws_latitude", "ws_longitude")] spatially closest point to A[i,c("ws_latitude", "ws_longitude")] 
    # or, equivalently
    
    # Compute euclidian distance between A[i,c("ws_latitude", "ws_longitude")] and each point in B-temp
    tmp=sqrt(rowSums(
      as.matrix(B_temp[c("ws_latitude", "ws_longitude")])-
        matrix(rep(ref_points,dim(B_temp)[1]),ncol=2,byrow = T))^2)
    
    # Find the minimum
    mindist=which.min(tmp)
    AB$newvar[i]=B_temp$var1.pred[mindist]
  }
  colnames(AB)[colnames(AB)==tail(colnames(AB),1)]=var_name
  return(AB[c("time",var_name)])
}

```

## Spatial kriging

```{r}
#
spat_kr=function(x_shr,var_name,grid_coords){
  
  # x_shr is the weather var dataframe in wide format considering only relevant times (see (*) above)
  
  res_fin=NULL
  coordinates(grid_coords) <- ~ ws_latitude + ws_longitude 
  #var_name="air_temp"
  for(i in 1:nrow(x_shr)){
    
    # sp_indx=locations$id%in%colnames(air_temp1_sp.full_shrink)
    # x_sp =locations[sp_indx,c("latitude","longitude","id")]
    # x_sp$var=as.vector(air_temp1_sp.full_shrink[i,-1])
    
    x_shr_long=x_shr[i,] %>%
      pivot_longer(!time, names_to = "id", values_to = "value")
    x_shr_long$id=as.factor(x_shr_long$id)
    
    x_shr_long2=merge(x_shr_long,locations,by="id")
    x_shr_long2=x_shr_long2[c("latitude", "longitude", "value")]
    
    coordinates(x_shr_long2) = ~ latitude + longitude
    
    # 1. Calculate the sample variogram. This is done with the variogram function
    v.vgm <- variogram(value~1, x_shr_long2)
    #plot(v.vgm)
    
    # 2. Fit a model to the sample variogram
    v.fit <- fit.variogram(v.vgm, vgm(100,"Gau",100,0))
    
    #plot(v.vgm, v.fit)
    
    v.kriged <- krige(value ~ 1, x_shr_long2, grid_coords, model=v.fit)
    
    res=v.kriged %>% as.data.frame
    res$time=x_shr$time[i]
    res=res[c("time","ws_latitude","ws_longitude","var1.pred")]
    colnames(res)[4]=var_name
    
    res_fin=cbind(res,res_fin)
  }
  return(res_fin)
}

```

Run spatial kriging for each weather variable

$\textbf{Air Temperature}$
```{r}
# (*)In air_temp (and all other weather vars), consider only times at which we have survey measurement

t_indx1=air_temp1_sp.full$time%in%df_cozie$time
air_temp1_sp.full_shrink=air_temp1_sp.full[t_indx1,]
t_indx2=air_temp2_sp.full$time%in%df_cozie$time
air_temp2_sp.full_shrink=air_temp2_sp.full[t_indx2,]
air_kriged1=spat_kr(air_temp1_sp.full_shrink,"air_temp",grid_coords)
air_kriged2=spat_kr(air_temp2_sp.full_shrink,"air_temp",grid_coords)
air_kriged=rbind(air_kriged1,air_kriged2)
air_kriged=drop_na(air_kriged)

save(air_kriged,file="air_kriged.Rdata")

```

$\textbf{Rainfall}$
```{r}
# (*)In air_temp (and all other weather vars), consider only times at which we have survey measurement

t_indx1=rainfall1_sp.full$time%in%df_cozie$time
rainfall1_sp.full_shrink=rainfall1_sp.full[t_indx1,]
t_indx2=rainfall2_sp.full$time%in%df_cozie$time
rainfall2_sp.full_shrink=rainfall2_sp.full[t_indx2,]
rainfall_kriged1=spat_kr(rainfall1_sp.full_shrink,"rainfall",grid_coords)
rainfall_kriged2=spat_kr(rainfall2_sp.full_shrink,"rainfall",grid_coords)
rainfall_kriged=rbind(rainfall_kriged1,rainfall_kriged2)
rainfall_kriged=drop_na(rainfall_kriged)

save(rainfall_kriged,file="rainfall_kriged.Rdata")


```


$\textbf{Relative humidity}$
```{r}
# (*)In air_temp (and all other weather vars), consider only times at which we have survey measurement

t_indx1=RH1_sp.full$time%in%df_cozie$time
RH1_sp.full_shrink=RH1_sp.full[t_indx1,]
t_indx2=RH2_sp.full$time%in%df_cozie$time
RH2_sp.full_shrink=RH2_sp.full[t_indx2,]
RH_kriged1=spat_kr(RH1_sp.full_shrink,"relative_humidity",grid_coords)
RH_kriged2=spat_kr(RH2_sp.full_shrink,"relative_humidity",grid_coords)
RH_kriged=rbind(RH_kriged1,RH_kriged2)
RH_kriged=drop_na(RH_kriged)

save(RH_kriged,file="RH_kriged.Rdata")


```

$\textbf{Wind Speed}$
```{r}
# (*)In air_temp (and all other weather vars), consider only times at which we have survey measurement

t_indx1=wind_speed1_sp.full$time%in%df_cozie$time
wind_speed1_sp.full_shrink=wind_speed1_sp.full[t_indx1,]
t_indx2=wind_speed2_sp.full$time%in%df_cozie$time
wind_speed2_sp.full_shrink=wind_speed2_sp.full[t_indx2,]
wind_speed_kriged1=spat_kr(wind_speed1_sp.full_shrink,"wind_speed",grid_coords)
wind_speed_kriged2=spat_kr(wind_speed2_sp.full_shrink,"wind_speed",grid_coords)
wind_speed_kriged=rbind(wind_speed_kriged1,wind_speed_kriged2)
wind_speed_kriged=drop_na(wind_speed_kriged)
save(wind_speed_kriged,file="wind_speed_kriged.Rdata")
```

$\textbf{Wind Direction}$
```{r}
# (*)In air_temp (and all other weather vars), consider only times at which we have survey measurement

t_indx1=wind_dir1_sp.full$time%in%df_cozie$time
wind_dir1_sp.full_shrink=wind_dir1_sp.full[t_indx1,]
t_indx2=wind_dir2_sp.full$time%in%df_cozie$time
wind_dir2_sp.full_shrink=wind_dir2_sp.full[t_indx2,]
wind_dir_kriged1=spat_kr(wind_dir1_sp.full_shrink,"wind_dir",grid_coords)
wind_dir_kriged2=spat_kr(wind_dir2_sp.full_shrink,"wind_dir",grid_coords)
wind_dir_kriged=rbind(wind_dir_kriged1,wind_dir_kriged2)
wind_dir_kriged=drop_na(wind_dir_kriged)
save(wind_dir_kriged,file="wind_dir_kriged.Rdata")

```


## Match survey/physio and weather data

```{r}
# Format long
# x_shr_long=x_shr%>%
#       pivot_longer(!time, names_to = "id", values_to = "value")
# x_shr_long$id=as.factor(x_shr_long$id)
#     
#     x_shr_long2=merge(x_shr_long,locations,by="id")
#     x_shr_long2=x_shr_long2[c("latitude", "longitude", "value")]
```


```{r}
match_krg_weath_coz=function(A,B,var_name){
  # A is the physio and survey dataset
  # B is the weather variable dataset after kriging has been performed
  # var_name is the name of the weather variable
  
  #   A=df_cozie[,c("time","q_thermal_preference","ts_step_count","ws_latitude","ws_longitude")]
  # B=x_kriged
  
  AB=A
  AB$newvar=0
  # Find closest in time
  for(i in 1:nrow(A)){
    ti=A$time[i]
    t_ind=which(B$time==ti)
    
    if(length(t_ind)!=0){
      # Find closest in space
      B_temp=B[t_ind,]
      
      ref_points=unlist(as.vector(A[i,c("ws_latitude", "ws_longitude")]))
      
      # Find point in B_temp[c("ws_latitude", "ws_longitude")] spatially closest point to A[i,c("ws_latitude", "ws_longitude")] 
      # or, equivalently
      
      # Compute euclidian distance between A[i,c("ws_latitude", "ws_longitude")] and each point in B-temp
      tmp=sqrt(rowSums(
        as.matrix(B_temp[c("ws_latitude", "ws_longitude")])-
          matrix(rep(ref_points,dim(B_temp)[1]),ncol=2,byrow = T))^2)
      
      # Find the minimum
      mindist=which.min(tmp)
      AB$newvar[i]=B_temp[mindist,var_name]
    }
  }
  
  AB$newvar[which(AB$newvar==0)]=NA
  AB=drop_na(AB)
  colnames(AB)[dim(AB)[2]]=var_name
  return(AB)
}
```

Matching

```{r}

air_match=match_krg_weath_coz(df_cozie,air_kriged,var_name="air_temp")
rainfall_match=match_krg_weath_coz(df_cozie,rainfall_kriged,var_name="rainfall")
RH_match=match_krg_weath_coz(df_cozie,RH_kriged,var_name="relative_humidity")
wind_speed_match=match_krg_weath_coz(df_cozie,wind_speed_kriged,var_name="wind_speed")
wind_dir=match_krg_weath_coz(df_cozie,wind_dir,var_name="wind_dir")

# TO DO: MERGE OF THESE 5 DATASETS ABOVE

```

