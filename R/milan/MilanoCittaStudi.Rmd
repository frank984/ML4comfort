---
title: "SVF e GVF - Milano Città Studi"
output: html_document
date: "2024-01-08"
---

```{r setup, include=FALSE} 
knitr::opts_chunk$set(warning = FALSE, message = FALSE) 
```

```{r}
library(geojsonio)
library(leaflet)
library(leaflet.extras)
library(dplyr)
library(lubridate)
library(htmltools)
```


## GSV2SVF

GSV2SVF is designed to interactively calculate sky/tree/building view factors from Google Street View (GSV) panoramas in Google Maps. 

## Data

We consider data only for the sky and green view factors (SVF, GVF). We restrict our attention to the area of Città Studi.

```{r}
df=read.csv("Milano-CittaStudi.csv")
df$date=ym(df$date)
str(df)
summary(df[,c("svf","tvf")])
```

## Thresholds 

We now set the threshold based on the 30% and 90% quantiles of the empirical distributions for SVF and GVF.

```{r}
q_svf=quantile(df$svf,probs = c(.3,.9)); q_svf
q_tvf=quantile(df$tvf,probs=c(.3,.9)); q_tvf
```


```{r}
scn=c("Clear sky","Urban canyon","Green canyon")

FirstScen=df[which(df$svf>q_svf[2]),c("lat","lon","date","svf","tvf")]
FirstScen$Scen=as.factor(scn[1])
SecondScen=df[which(df$svf<q_svf[1]&df$tvf<q_tvf[1]),
              c("lat","lon","date","svf","tvf")]
SecondScen$Scen=as.factor(scn[2])
ThirdScen=df[which(df$svf<q_svf[1]&df$tvf>q_svf[2]),
             c("lat","lon","date","svf","tvf")]
ThirdScen$Scen=as.factor(scn[3])
df2=full_join(FirstScen,SecondScen)
df2=full_join(df2,ThirdScen)
```

```{r}
df2[,c("date","Scen")]
```


```{r}
labels <- paste(
  "<strong>", df2$lat,
  "</strong><br>Building:", df2$lon) %>%
  lapply(htmltools::HTML)

pal <- colorFactor(c("blue", "green","red"), domain = scn)
#colnames(df2)[1:2]=c("long","lat")
leaflet(df2) %>% addTiles() %>%
  #addProviderTiles(providers$CartoDB.Positron)%>%
  addCircleMarkers(
    radius = 7,
    color = ~pal(Scen),
    stroke = FALSE, fillOpacity = 1,
    #labels=~labels,
    popup = ~paste("<br>Lat:",lat, "<br>Lon:", lon,
                            "<br>SVF:",svf,"<br>GVF:",tvf)
    )%>%
  addLegend("topleft", pal = pal, 
            values = ~Scen,
    title = "Scenario",
    labFormat = labelFormat(prefix = " "),
    opacity = 1
  )
```
